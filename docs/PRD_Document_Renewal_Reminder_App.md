# Document Renewal Reminder App

## 製品要件・開発計画（PRD）

> **Product Completion**: 98/100 points  
> **Last Updated**: 2026年1月8日  
> **Current Phase**: Phase 8 (Mobile Device Testing)

---

## 1. プロジェクト背景と目的

本プロジェクトは **Flutterクロスプラットフォーム（iOS/Android/macOS）モバイルアプリ** を開発し、個人および家族の各種証明書の有効期限を一元管理し、**証明書が「更新申請可能期間」に入った際にスマートリマインダーで通知**することで、申請忘れによるリスクを防ぐことを目的としています。

### コア目標

* 家族メンバーの各種証明書を管理
* 証明書タイプごとのルールに基づくスマートリマインダー
* アプリが開いていなくても確実に通知（24時間バックグラウンドタスク）
* 多言語対応（日本語 / 英語 / 中国語）
* データのエクスポート/インポート機能（JSONバックアップ、上書きモード）
* カレンダー同期機能（iOS/Android）
* バックエンド不要、有料API不使用、完全オフライン運用

---

## 2. 対象ユーザー

* 在日外国人およびその家族
* 複数の定期更新が必要な証明書を持つ個人・家族
* シンプルなツールで証明書更新忘れを防ぎたいユーザー

---

## 3. プラットフォームと技術選定

### プラットフォーム

* iOS
* Android
* macOS（開発用、通知制限あり）
* Web（Hive対応、通知未対応）

### 技術フレームワーク

* Flutter 3.0+
* Dart

### ローカルストレージ

* SQLite（sqflite） - iOS/Android/macOS
* Hive - Web
* データは端末内のみ保存

### 通知方式

* システムローカル通知（Local Notifications）
* `flutter_local_notifications`を使用
* バックグラウンドタスク（`workmanager`）- 24時間ごとに自動チェック
* Firebase / APNsは使用しない

### 多言語

* Flutter intl
* ARB 文件管理文案
* 初期対応：

  * 中国語（簡体字）
  * 日本語
  * 英語（オプション）

---

## 4. 機能要件

### 4.1 家族メンバー管理（Family）

#### 機能

* 家族メンバーの追加 / 編集 / 削除
* メンバー関係タイプ：

  * 本人
  * 配偶者
  * 子供

#### データ項目

* member_id
* name
* relation
* birthday（任意）

---

### 4.2 証明書管理（Document）

#### 対応証明書タイプ（MVP）

* 在留カード
* パスポート
* 運転免許証
* 身分証明書
* マイナンバー

#### 証明書項目

* document_id
* member_id
* document_type
* country（任意）
* document_number（任意）
* expiry_date（必須）
* renewal_policy_id
* remark

---

### 4.3 証明書更新ルール（Renewal Policy）

#### 設計方針

* ルール駆動（固定日数ではない）
* AIによる日付計算は使用しない
* ユーザーがデフォルトルールを手動で上書き可能

#### ルール例

| 証明書タイプ     | デフォルト申請可能期間  |
| -------- | -------- |
| 在留カード      | 有効期限の3ヶ月前 |
| パスポート（中国）   | 有効期限の6ヶ月前 |
| 運転免許証       | 有効期限の1ヶ月前 |
| マイナンバー | 有効期限の3ヶ月前 |

#### コア計算ロジック

```
remind_start_date = expiry_date - renewal_months_before
```

---

### 4.4 スマートリマインダーシステム（Reminder）

#### リマインダー発火ロジック

* 証明書が「申請可能期間」に入った後のみリマインダー開始
* デフォルトは毎日1回通知
* システムローカル通知を使用
* アプリが開いていなくても通知が有効

---

### 4.5 証明書状態遷移（State Machine）

```
NORMAL
  ↓（申請可能期間に入る）
REMINDING
  ↓（ユーザーが「更新開始」を確認）
PAUSED
  ↓（予定完了日を過ぎる）
REMINDING
  ↓（ユーザーが新しい有効期限を入力）
NORMAL
```

---

### 4.6 ユーザー確認・一時停止メカニズム

ユーザーが「更新開始」をタップした場合：

* 予定完了日（expected_finish_date）を入力
* リマインダーを一時停止
* 予定完了日を過ぎても証明書が更新されていない場合 → 自動的にリマインダー再開

---

## 5. 多言語設計（Flutter intl）

### 設計方針

* 文言（テキスト）とロジックを完全に分離
* すべてのUI・通知文言はintl keyで管理
* コード内に言語テキストをハードコーディングしない

### ARB文例

```json
"remind.title.residence_card": "在留カードの更新が必要です",
"remind.body.default": "{name}の{doc}は更新申請可能期間に入りました（残り{days}日）"
```

---

## 6. 非機能要件

* 完全オフライン利用可能
* アカウント不要
* バックエンド依存なし
* 起動速度が速い
* UIはシンプルでツール指向

---

## 7. MVP開発計画

### フェーズ1（Week 1）

* Flutterプロジェクト初期化
* データモデル設計
* 家族メンバー＆証明書CRUD

### フェーズ2（Week 2）

* 更新ルールシステム
* リマインダー時間計算
* ローカル通知登録・解除

### フェーズ3（Week 3）

* 状態遷移ロジック
* 多言語対応（intl）
* iOS / Android実機テスト

---

## 8. 追加機能要件（2026-01-08更新）

### 8.1 データエクスポート/インポート機能 ✅ **完了**（Phase 8.5.1）

#### 实装状態
* ✅ JSON形式のエクスポート/インポート実装済み
* ✅ **上書きモード**：インポート時に既存データを全削除
* ✅ share_plus統合（iOS/Android）
* ✅ file_picker統合（ファイル選択）
* ✅ 警告ダイアログ実装（データ削除の明示的な警告）
* ✅ 多言語対応（ja/en/zh）

#### 実装功能
* データエクスポート：全FamilyMember、Document、ReminderStateをJSON出力
* データインポート：JSONファイルから復元（既存データを上書き）
* ファイル共有：iOS/Androidのシェアシートで送信
* ID自動マッピング：旧ID → 新ID自動変換

#### ファイル形式
```json
{
  "version": "1.0",
  "exportDate": "2026-01-08T12:30:45.123Z",
  "members": [...],
  "documents": [...],
  "reminderStates": [...]
}
```

#### 技術実装
* DataExportService（lib/features/settings/service/）
* share_plus: ^7.2.2
* file_picker: ^6.2.1
* ファイル名形式：doc_reminder_backup_YYYY-MM-DDTHH-MM-SS.json

### 8.2 通知信息一览功能（优先级：中） 📋 **計画中**（Phase 8.5.2）

#### 機能
* 設定タブに「通知一覧」ページを新設
* すべてのスケジュール済み通知を表示
* 表示内容：
  - 家族メンバー名
  - 証明書タイプ
  - 通知日時
  - 通知状態（スケジュール済み／送信済み／キャンセル済み）
* 操作：
  - 通知詳細の表示
  - 個別通知のキャンセル
  - 通知の再スケジュール

#### 技术要点
* 从ReminderStateRepository获取数据
* 与NotificationService集成
* 实时更新通知状态

### 8.3 后台通知功能 ✅ **已完成**（Phase 8.1）

#### 実装状態
* ✅ workmanagerパッケージ統合
* ✅ 24時間ごとのバックグラウンドタスク実装
* ✅ BackgroundTaskService実装
* ✅ ReminderEngine・ReminderScheduler統合
* ✅ iOS/Android対応（macOS/Web除外）

#### 実装功能
* 毎日自動チェック：アプリ完全終了時も動作
* 全証件の有効期限チェック
* リマインダー期間に入った証件の自動通知スケジュール
* ReminderState状態の自動更新

#### 技術実装
* BackgroundTaskService（lib/core/background/）
* workmanager: ^0.5.2
* 実行頻度：24時間ごと
* 初回実行：登録から15分後

### 8.4 通知アクションダイアログ ✅ **已完成**（Phase 8.4）

#### 実装状態
* ✅ DocumentActionDialog実装
* ✅ 「更新開始」「更新完了」ボタン
* ✅ ReminderState状態遷移（REMINDING → PAUSED → NORMAL）
* ✅ 通知の一時停止/再開機能
* ✅ 有効期限日の最終警告通知（通知ID: documentId * 1000 + 999）

#### 実装功能
* 証件カードタップでダイアログ表示
* 現在の通知状態表示（通知中/一時停止/通常）
* 更新開始：REMINDING → PAUSED、通常通知停止、最終警告スケジュール
* 更新完了：任意状態 → NORMAL、全通知キャンセル

### 8.5 カレンダー同期 ✅ **已完成**（Phase 8.3）

#### 実装状態
* ✅ add_2_calendarパッケージ統合
* ✅ リマインダー開始日をカレンダーに追加
* ✅ iOS/Android対応（macOS未対応）
* ✅ 証件ごとにON/OFF切り替え可能

#### 実装功能
* カレンダーイベント自動作成
* イベント内容：証件タイプ、有効期限、証件番号、備考
* 終日イベントとして登録
* プラットフォーム制限の自動処理

---


## 8. 追加機能要件（2026-01-08更新）

### 8.1 データエクスポート/インポート機能 ✅ **完了**（Phase 8.5.1）
* JSON形式のエクスポート/インポート（上書きモード、警告ダイアログ、ID自動マッピング、多言語対応）
* share_plus・file_picker連携、バックアップファイル名規則

### 8.2 通知一覧機能（優先度：中） 📋 **計画中**（Phase 8.5.2）
* 設定タブに「通知一覧」ページ新設、全通知の状態・詳細・操作（キャンセル/再スケジュール）

### 8.3 バックグラウンド通知機能 ✅ **完了**（Phase 8.1）
* workmanagerによる24時間周期の自動チェック、バックグラウンド通知、ReminderEngine連携

### 8.4 通知アクションダイアログ ✅ **完了**（Phase 8.4）
* 証明書カードから通知状態・操作（更新開始/完了/一時停止/再開/最終警告）

### 8.5 カレンダー同期 ✅ **完了**（Phase 8.3）
* add_2_calendar連携、リマインダー開始日をカレンダー登録、ON/OFF切替、プラットフォーム制限

## 9. 現在の状態（2026年1月8日）
* 製品完成度: 98/100点
* モバイル実機テストフェーズ

## 10. 今後の拡張方針

### 10.1 サポート・フィードバック入口の要件（2026-01-09追加）
* 設定タブに「お問い合わせ・ご意見」入口（GitHubリンク、メール自動起動、UIはシンプル）
* 広告なし・ユーザーデータ収集なし・寄付は任意・フィードバックは必ず開発者に届く
* 今後「カスタム機能解放」等の拡張もこの入口から

### その他拡張候補
* OCR証明書識別
* 家庭多設備同期
* 企業/HR証明書管理版
* AI文案補助
* 生体認証（Face ID / Touch ID）

#### 設計方針・備考
- 広告を導入しない、ユーザーデータを収集しない
- 寄付は完全任意（※現状寄付機能は未実装）、多言語説明に対応
- フィードバックは必ず開発者に届く仕組みとする
- 本要件は今後の拡張項目であり、現時点ではPRDに明記のみ。具体的なUIや実装詳細は後日追加。

---

## 11. MVP 成功標準 ✅ **達成済み**

* ✅ ユーザーがアプリを開かなくても通知を受け取れる（バックグラウンドタスク実装済み）
* ✅ 証明書の申請可能期間を逃さない（ルール駆動システム）
* ✅ データ構造が高い拡張性を持つ（SQLite/Hive）
* ✅ 多言語体系が完全かつ保守可能（ja/en/zh）
* ✅ データバックアップ・復元機能（JSONエクスポート/インポート）

---

## 12. 総結

本プロジェクトは「安定・低コスト・高い実用性」をコア原則とし、
「迅速な実用化・現実的な課題解決・長期的な拡張性」を備えたモバイルアプリです。